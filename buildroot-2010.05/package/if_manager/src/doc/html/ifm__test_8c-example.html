<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>IF MANAGER: ifm_test.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>ifm_test.c</h1><p>the example of using if_manager</p>
<div class="fragment"><pre class="fragment"><span class="comment">/************************************************************************</span>
<span class="comment"> * </span>
<span class="comment"> *  Copyright (C) 2010 by Amlogic, Inc. All Rights Reserved.</span>
<span class="comment"> *</span>
<span class="comment"> *  Description: ifm_test for user, display the sample use of if_manager</span>
<span class="comment"> *</span>
<span class="comment"> *  Author: tianyu.li</span>
<span class="comment"> *</span>
<span class="comment"> ************************************************************************/</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>

<span class="comment">/*the ip_addr header files*/</span>
<span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<span class="preprocessor">#include &lt;netinet/in.h&gt;</span>

<span class="comment">/*if_manager interface file, it included ifm_def.h already*/</span>
<span class="preprocessor">#include &quot;<a class="code" href="if__manager_8h.html" title="the interface of if_manager for UI">if_manager.h</a>&quot;</span>

<span class="keyword">typedef</span> <span class="keyword">struct </span>{
    <span class="keywordtype">char</span> ifname[10];
    <span class="keywordtype">int</span>  state_index;
}netif_node;

<span class="preprocessor">#define MAX_NETIF_NUM 3</span>
<span class="preprocessor"></span>
netif_node netifs[MAX_NETIF_NUM];
<span class="keyword">static</span> <span class="keywordtype">int</span> i;

<span class="comment">/*the callback to watch the netif state change*/</span>
<span class="keywordtype">void</span> SMG_notify_network_status_cb( <span class="keywordtype">int</span> if_id,<span class="keywordtype">char</span> *if_name, <span class="keywordtype">int</span> state )
{
    <span class="comment">/*print the state of the netif*/</span>
    <span class="keywordtype">int</span> i ;
    <span class="keywordtype">int</span> new_index = 0;
    <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
    {
        <span class="keywordflow">if</span> (netifs[i].ifname[0] == 0x0 &amp;&amp; new_index == 0)
            new_index = i;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(netifs[i].ifname, if_name, strlen(if_name)) == 0)
        {
            netifs[i].state_index = state;
            <span class="keywordflow">break</span>;
        } 
    }
    <span class="keywordflow">if</span> (i == 3)
    {
        <span class="keywordflow">if</span> (new_index == 0)
        {
            printf(<span class="stringliteral">&quot;no free netif to insert!\n&quot;</span>);
            <span class="keywordflow">return</span>;
        }
        strncpy(netifs[new_index].ifname, if_name, strlen(if_name));
        netifs[new_index].state_index = state;
        i = new_index;
    }
    printf( <span class="stringliteral">&quot;%s %s\n&quot;</span>, netifs[i].ifname, ifm_if_state_descs[ netifs[i].state_index] );
    <span class="keywordflow">return</span>;
}


<span class="keywordtype">int</span> main()
{
    <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="structifm__if__cfg.html" title="the struct of the full information of one netif">ifm_if_cfg</a> if_cfg;
    <span class="keywordtype">int</span> ret, state;
    memset(netifs, 0x0, <span class="keyword">sizeof</span>(netifs));
<span class="comment">/*to start the if_manager, you must finish the following steps:</span>
<span class="comment"> *first, call ifm_init() to init netif list</span>
<span class="comment"> *second, call ifm_register_state_changed_cb() to register callback to the netif list</span>
<span class="comment"> *last, call ifmd_start() to start the daemon process</span>
<span class="comment"> *NOTE: DO NOT change the order! and DO call them before you use if_manager*/</span>
    <a name="a1"></a><a class="code" href="if__manager_8h.html#a68da6f50082a2deea61c68f686d6b7ce">ifm_init</a>();
    ret = <a name="a2"></a><a class="code" href="if__manager_8h.html#a8ffe6fabcc01b9f0fe1774ee38955274">ifm_register_state_changed_cb</a>( NULL, SMG_notify_network_status_cb );
    <span class="keywordflow">if</span> (ret &lt; 0)
        printf(<span class="stringliteral">&quot;can not register state changed cb!\n&quot;</span>);
    <span class="keywordtype">int</span> i = <a name="a3"></a><a class="code" href="if__manager_8h.html#a5993db3c6141c4ddce4c2f8f8ec1c01e">ifmd_start</a>();
    <span class="keywordflow">if</span> (i == IFM_IFMD_START_FAILED)
    {
        printf(<span class="stringliteral">&quot;wrong!wrong!wrong!\n&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }
    
    sleep(3); 
    
    <span class="keywordflow">while</span>(1)<span class="comment">/*endless*/</span>
    {
        <span class="comment">/*test for getting interface configure*/</span>
        <span class="keywordflow">for</span> ( i = 0; i &lt; 3; i++ ) 
        {
            <span class="keywordflow">if</span> (netifs[i].ifname[0] == 0x0)
                <span class="keywordflow">continue</span>;
            ret = <a name="a4"></a><a class="code" href="if__manager_8h.html#a0aa51134f33a2124a542c677f45949c8">ifm_get_if_cfg</a>( netifs[i].ifname, &amp;if_cfg );
            
            printf( <span class="stringliteral">&quot;interface: %s\n&quot;</span>,netifs[i].ifname );
            <span class="keywordflow">if</span> (strncmp(netifs[i].ifname, <span class="stringliteral">&quot;wlan0&quot;</span>, 5) == 0)
            {
                <span class="comment">/*test if the netif has ip*/</span>
                <span class="keywordflow">if</span> (ret == 0 &amp;&amp; if_cfg.ip_str[0] != 0)
                    printf(<span class="stringliteral">&quot;wlan0 is ready!\n&quot;</span>);
                <span class="keywordflow">else</span>
                {
                    <span class="comment">/*to get the ap scan result, you should declare a variable sc_result*, to get the list head*/</span>
                    <a name="_a5"></a><a class="code" href="structsc__result.html" title="the result list of AP scanning">sc_result</a> *p_scan_list, *p;
                    <span class="comment">/*scan and get the result*/</span>
                    <span class="keywordflow">if</span>((ret = ifm_ap_scan(netifs[i].ifname, &amp;p_scan_list)))
                    {
                        printf(<span class="stringliteral">&quot;error: %d\n&quot;</span>, ret);
                        <span class="keywordflow">continue</span>;
                    }
                    p = p_scan_list;
                    <span class="keywordflow">while</span> (p != NULL)
                    {
                        printf( <span class="stringliteral">&quot;ssid: %s\n&quot;</span>, p-&gt;<a name="a6"></a><a class="code" href="structsc__result.html#a1ad640e79cc10ba4b3dc9a06311c6254">ssid</a> );
                        printf( <span class="stringliteral">&quot;pass_mode: %s\n&quot;</span>, p-&gt;<a name="a7"></a><a class="code" href="structsc__result.html#aa96a0eb01616a033bdf3aaa247a1ac5f">pass_mode</a> );
                        printf( <span class="stringliteral">&quot;strength: %d\n&quot;</span>,p-&gt;<a name="a8"></a><a class="code" href="structsc__result.html#af0114dc9171a9bdc183e54e510bd861d">strength</a> );
                        <span class="keywordflow">if</span>(strstr(p-&gt;<a class="code" href="structsc__result.html#a1ad640e79cc10ba4b3dc9a06311c6254">ssid</a>, <span class="stringliteral">&quot;AML_BJ&quot;</span>))
                        {
                            <span class="comment">/*start to connect to the chosen AP, and the network*/</span>
                            ret = <a name="a9"></a><a class="code" href="if__manager_8h.html#ae1bb3ae84cab370fd8397343e6a613ed">ifm_set_if_wifi_addrs</a>(netifs[i].ifname, 1, p-&gt;<a class="code" href="structsc__result.html#a1ad640e79cc10ba4b3dc9a06311c6254">ssid</a>, p-&gt;<a class="code" href="structsc__result.html#aa96a0eb01616a033bdf3aaa247a1ac5f">pass_mode</a>, <span class="stringliteral">&quot;aml11&quot;</span>, NULL, NULL, NULL, NULL, NULL);
                            printf(<span class="stringliteral">&quot;set wifi ret: %d\n&quot;</span>, ret);
                        }
                        p = p-&gt;<a name="a10"></a><a class="code" href="structsc__result.html#a7a7467dc7bebc70791dc1e2c962f14d6">next</a>;
                    }
                    <span class="keywordflow">if</span> (p_scan_list)
                        <a name="a11"></a><a class="code" href="if__manager_8h.html#a81d7715b38dc8d4dac7b843e6b2d7116">ifm_free_ap_list</a>(&amp;p_scan_list);
                }
            }
            <span class="keywordflow">if</span> ( 0 == ret ) 
            {
                <span class="comment">/*print the ip information of all netif which has got ip*/</span>
                printf( <span class="stringliteral">&quot;inet addr: %s\n&quot;</span>,if_cfg.ip_str );
                printf( <span class="stringliteral">&quot;broadcast addr: %s\n&quot;</span>,if_cfg.bc_ip_str );
                printf( <span class="stringliteral">&quot;inet mask: %s\n&quot;</span>,if_cfg.netmask_str );
                printf( <span class="stringliteral">&quot;gateway: %s\n&quot;</span>,if_cfg.gateway_str );
                <span class="keywordflow">if</span> (*(if_cfg.dns1_str) != 0x0)
                    printf( <span class="stringliteral">&quot;primary dns addr: %s\n&quot;</span>,if_cfg.dns1_str );
                <span class="keywordflow">else</span>
                    printf(<span class="stringliteral">&quot;can not got primary dns addr!\n&quot;</span>);
                <span class="keywordflow">if</span> (*(if_cfg.dns2_str) != 0x0)
                    printf( <span class="stringliteral">&quot;second dns addr: %s\n&quot;</span>,if_cfg.dns2_str );
                <span class="keywordflow">else</span>
                    printf(<span class="stringliteral">&quot;can not got second dns addr!\n&quot;</span>);
            }
            printf( <span class="stringliteral">&quot;\n&quot;</span> );
        }
        printf(<span class="stringliteral">&quot;the network is %s\n&quot;</span>, <a name="a12"></a><a class="code" href="if__manager_8h.html#a4db743bda06a7ce1e9bceea73917be08">ifm_check_network</a>() ? <span class="stringliteral">&quot;connected&quot;</span> : <span class="stringliteral">&quot;disconnected&quot;</span>);
        sleep(3);
    }
}

</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Thu Apr 15 16:52:29 2010 for IF MANAGER by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
